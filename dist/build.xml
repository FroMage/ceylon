<?xml version="1.0" encoding="UTF-8"?>
<project name="ceylon-dist" default="help" basedir=".">

    <tstamp>
        <format property="NOW" pattern="yyyyMMddHHmm" />
    </tstamp>

    <property file="build.properties"/>
    <property name="projects.dir" value="${basedir}/projects"/>
    <property name="dist.dir" value="${basedir}/dist"/>

    <target name="help">
        <echo>Options for building a Ceylon distribution package:
    ant release            - Does a clean, get-code, local, package
                             using the sources tagged with the name as
                             defined by ceylon.version in build.properties
                             Use this when doing a release!

    ant nightly            - Does a clean, get-code, local, package
                             using the sources from master.
                             Use this when NOT doing a release!

Some more basic ant tasks:
    ant get-code           - Downloads latest code for all projects
    ant get-code -Dtag=0.3 - Downloads latest code and checks out the tag
    ant checkout -Dtag=0.3 - Makes sure we're using the specified tag
    ant checkout-master    - To make sure we're using master

    ant local install-all  - Quick builds the distribution projects, cloning/pulling 
                             dependent Ceylon git repositories into the 
                             ${projects.dir} directory.
                             Doesn't touch any sibling project folders.
                             Doesn't touch your local repo (~/.ceylon/repo).
    ant local package      - Same as install-all but will clean projects first and
                             will generate documentation and the final distribution
                             package

    ant siblings install-all - Quick builds the distribution projects using
                             existing sibling project folders.
                             Doesn't clone or pull. Doesn't touch your local 
                             repo (~/.ceylon/repo).
    ant siblings package   - Same as install-all but will clean projects first and
                             will generate documentation and the final distribution
                             package

    ant clean              - Cleans the distribution package
    ant clean-all          - Cleans the distribution package
                             and deletes all local projects</echo>
    </target>

    <target name="release"
            description="Does a clean, get-code, local, package using the 
sources tagged with the name as defined by ceylon.version in 
build.properties
Use this when doing a release!">
        <property name="tag" value="${ceylon.version}"/>
        <antcall target="bootstrap" />
    </target>

    <target name="nightly"
            description="Does a clean, get-code, local, package using the sources from master. 
Use this when NOT doing a release!">
        <property name="dist.name" value="ceylon-${ceylon.version}-master-${NOW}"/>
        <antcall target="bootstrap" />
    </target>

    <target name="bootstrap" depends="clean,get-code,local,package">
    </target>

    <target name="local"
            description="Builds using dependent projects in the ${projects.dir} directory.
Used with another target such as 'package'.">
        <property name="projects.base.dir" value="${projects.dir}"/>
        <property name="ceylon-common.dir" value="${projects.base.dir}/ceylon-common"/>
        <property name="ceylon-compiler.dir" value="${projects.base.dir}/ceylon-compiler"/>
        <property name="ceylon-spec.dir" value="${projects.base.dir}/ceylon-spec"/>
        <property name="ceylon.language.dir" value="${projects.base.dir}/ceylon.language"/>
        <property name="ceylon-module-resolver.dir" value="${projects.base.dir}/ceylon-module-resolver"/>
        <property name="ceylon-runtime.dir" value="${projects.base.dir}/ceylon-runtime"/>
        <property name="ceylon-js.dir" value="${projects.base.dir}/ceylon-js"/>
        <property name="dist.name" value="ceylon-${ceylon.version}"/>
    </target>

    <target name="siblings"
            description="Builds using dependent projects in existing sibling project folders.
Used with another target such as 'package'">
        <property name="projects.base.dir" value="${basedir}/.." />
        <property name="ceylon-common.dir" value="${projects.base.dir}/ceylon-common"/>
        <property name="ceylon-compiler.dir" value="${projects.base.dir}/ceylon-compiler"/>
        <property name="ceylon-spec.dir" value="${projects.base.dir}/ceylon-spec"/>
        <property name="ceylon.language.dir" value="${projects.base.dir}/ceylon.language"/>
        <property name="ceylon-module-resolver.dir" value="${projects.base.dir}/ceylon-module-resolver"/>
        <property name="ceylon-runtime.dir" value="${projects.base.dir}/ceylon-runtime"/>
        <property name="ceylon-js.dir" value="${projects.base.dir}/ceylon-js"/>
        <property name="dist.name" value="ceylon-${ceylon.version}-custom-${NOW}"/>
    </target>

    <target name="package" 
            depends="clean-projects, install-all, generate-spec, generate-apidoc, zip"
            description="Generates a distributable zip file">
    </target>

    <target name="clean-projects" 
            description="Cleans all sub projects">
        <ant antfile="${ceylon-common.dir}/build.xml" target="clean" dir="${ceylon-common.dir}" inheritall="false"/>
        <ant antfile="${ceylon-compiler.dir}/build.xml" target="clean" dir="${ceylon-compiler.dir}" inheritall="false"/>
        <ant antfile="${ceylon-js.dir}/build.xml" target="clean" dir="${ceylon-js.dir}" inheritall="false"/>
        <ant antfile="${ceylon-spec.dir}/build.xml" target="clean" dir="${ceylon-spec.dir}" inheritall="false"/>
        <ant antfile="${ceylon.language.dir}/build.xml" target="clean" dir="${ceylon.language.dir}" inheritall="false"/>
        <ant antfile="${ceylon-module-resolver.dir}/build.xml" target="clean" dir="${ceylon-module-resolver.dir}" inheritall="false"/>
        <ant antfile="${ceylon-runtime.dir}/build.xml" target="clean" dir="${ceylon-runtime.dir}" inheritall="false"/>
    </target>

    <target name="install-all" 
            depends="install-compiler, install-js, copy-compiler-binaries, 
                     copy-samples, copy-compiler-libraries, install-typechecker,
                     install-language, install-runtime"
            description="Generates all binaries and copies them to the distribution folder">
    </target>

    <target name="zip">
        <zip destfile="${basedir}/${dist.name}.zip">
            <zipfileset dir="${dist.dir}" prefix="${dist.name}">
                <include name="bin/**" />
                <exclude name="bin/ceylon*" />
            </zipfileset>
            <zipfileset dir="${dist.dir}" filemode="755"  prefix="${dist.name}">
                <include name="bin/ceylon*" />
            </zipfileset>
            <zipfileset dir="${dist.dir}" prefix="${dist.name}">
                <include name="doc/**" />
                <include name="lib/**" />
                <include name="repo/**" />
                <include name="runtime-repo/**" />
                <include name="samples/**" />
            </zipfileset>
            <zipfileset dir="${basedir}" prefix="${dist.name}">
                <include name="LICENSE-ASL" />
                <include name="LICENSE-GPL-CP" />
                <include name="NOTICE" />
                <include name="README.md" />
                <include name="README-ANT.md" />
            </zipfileset>
        </zip>        
	</target>
	
    <target name="copy-compiler-binaries">
        <mkdir dir="${dist.dir}/bin"/>
        <copy todir="${dist.dir}/bin">
            <fileset dir="${ceylon-compiler.dir}/build/bin">
                <include name="args.sh"/>
                <include name="args.bat"/>
                <include name="java.bat"/>
                <include name="ceylonc"/>
                <include name="ceylonc.bat"/>
                <include name="ceylond"/>
                <include name="ceylond.bat"/>
                <include name="ceylon-import-jar"/>
                <include name="ceylon-import-jar.bat"/>
            </fileset>
            <fileset dir="${ceylon-js.dir}/build/bin">
                <include name="ceylonc-js"/>
                <include name="ceylonc-js.bat"/>
                <include name="ceylon-js"/>
                <include name="ceylon-js.bat"/>
                <include name="c-js.sh" />
                <include name="c-js.bat" />
            </fileset>
        </copy>
        <chmod perm="0755">
            <fileset dir="${dist.dir}/bin">
                <include name="ceylonc"/>
                <include name="ceylond"/>
                <include name="ceylon-import-jar"/>
                <include name="ceylon-js"/>
                <include name="ceylonc-js"/>
            </fileset>
        </chmod>
    </target>

    <target name="copy-compiler-libraries">
        <mkdir dir="${dist.dir}/lib"/>
        <copy todir="${dist.dir}/lib">
            <fileset dir="${ceylon-compiler.dir}/build/lib">
                <include name="antlr-*-complete.jar"/>
                <include name="markdownj-*.jar"/>
                <include name="txtmark-*.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="copy-samples">
        <mkdir dir="${dist.dir}/samples"/>
        <copy todir="${dist.dir}/samples">
            <fileset dir="samples">
                <include name="helloworld/**"/>
                <include name="no-module/**"/>
                <include name="interop-java/**"/>
            </fileset>
        </copy>
    </target>

    <target name="install-compiler" 
          depends="install-typechecker, install-language">
        <ant antfile="${ceylon-compiler.dir}/build.xml" target="publish" dir="${ceylon-compiler.dir}" inheritall="false">
            <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>
    </target>

    <target name="install-js" depends="install-compiler">
        <ant antfile="${ceylon-js.dir}/build.xml" target="publish" dir="${ceylon-js.dir}" inheritall="false">
            <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>
    </target>

    <target name="install-typechecker" 
            depends="install-cmr, install-language">
        <ant antfile="${ceylon-spec.dir}/build.xml" target="publish" dir="${ceylon-spec.dir}" inheritall="false">
            <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>
        <!--<copy todir="${dist.dir}/repo">
            <fileset dir="${ceylon-spec.dir}/build/dist">
            </fileset>
        </copy>-->
    </target>

    <target name="install-language">
        <ant antfile="${ceylon.language.dir}/build.xml" target="publish" dir="${ceylon.language.dir}" inheritall="false">
            <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>
    </target>

    <target name="install-common">
        <ant antfile="${ceylon-common.dir}/build.xml" target="publish" dir="${ceylon-common.dir}" inheritall="false">
            <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>
    </target>

    <target name="install-cmr" depends="install-common">
        <ant antfile="${ceylon-module-resolver.dir}/build.xml" target="publish" dir="${ceylon-module-resolver.dir}" inheritall="false">
            <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>

        <copy todir="${dist.dir}/lib">
            <fileset dir="${ceylon-module-resolver.dir}/lib">
                <include name="sardine-*.jar"/>
                <include name="httpclient-*.jar"/>
                <include name="httpcore-*.jar"/>
                <include name="commons-logging-*.jar"/>
                <include name="commons-codec-*.jar"/>
                <include name="slf4j-*.jar"/>
                <include name="jandex-*.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="install-runtime" depends="install-cmr">
        <ant antfile="${ceylon-runtime.dir}/build.xml" target="dist" dir="${ceylon-runtime.dir}" inheritall="false">
          <property name="ceylon.repo.dir" value="${dist.dir}/repo"/>
        </ant>
        <copy todir="${dist.dir}">
            <fileset dir="${ceylon-runtime.dir}/build/dist">
            </fileset>
        </copy>
        <chmod perm="0755">
            <fileset dir="${dist.dir}/bin">
                <include name="ceylon"/>
            </fileset>
        </chmod>
    </target>

    <target name="generate-spec">
        <ant antfile="${ceylon-spec.dir}/build.xml" target="doc" dir="${ceylon-spec.dir}" inheritall="false"/>
        <copy todir="${dist.dir}/doc">
            <fileset dir="${ceylon-spec.dir}/build">
                <exclude name="dist,classes"/>
            </fileset>
        </copy>
    </target>

    <target name="generate-apidoc">
        <exec executable="${dist.dir}/bin/ceylond" failonerror="yes">
            <arg value="-out"/>
            <arg value="${dist.dir}/repo"/>
            <arg value="-src"/>
            <arg value="${ceylon.language.dir}/src/"/>
            <arg value="-source-code"/>
            <arg value="ceylon.language"/>
        </exec>
    </target>

    <target name="get-code" depends="use-git-pull,use-git-clone,checkout-tagged"
            description="Downloads latest code for all projects">
        <echo>
If you are building a distribution package for a specific tagged release
then execute the following command:

    ant checkout -Dtag=0.3.1 - Makes sure we're using the specified tag

or you can go straight to the package building:

    ant local package      - Builds the distribution package
</echo>
    </target>

    <target name="check-exists-projects-dir">
        <available property="projects.dir.exists" file="${projects.dir}" type="dir" />
    </target>

    <target name="use-git-clone" depends="check-exists-projects-dir" unless="${projects.dir.exists}">
        <antcall target="git-clone" />
    </target>
    <target name="git-clone">
        <mkdir dir="${projects.dir}"/>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon-common.git"/>
        </exec>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon-compiler.git"/>
        </exec>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon-spec.git"/>
        </exec>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon.language.git"/>
        </exec>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon-module-resolver.git"/>
        </exec>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon-runtime.git"/>
        </exec>
        <exec executable="git" dir="${projects.dir}" failonerror="yes">
            <arg value="clone"/>
            <arg value="git@github.com:ceylon/ceylon-js.git"/>
        </exec>
    </target>

    <target name="use-git-pull" depends="check-exists-projects-dir" if="${projects.dir.exists}">
        <antcall target="git-pull" />
    </target>
    <target name="git-pull" depends="checkout-master">
        <exec executable="git" dir="${projects.dir}/ceylon-common" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-compiler" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-spec" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon.language" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-module-resolver" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-runtime" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-js" failonerror="yes">
            <arg value="pull"/>
            <arg value="--ff-only"/>
        </exec>
    </target>

    <target name="checkout">
        <fail unless="tag" />
        <antcall target="checkout-internal">
            <param name="tag-internal" value="${tag}" />
        </antcall>
        <echo>
You can now build the package by executing:

    ant local package      - Builds the distribution package
</echo>
    </target>

    <target name="checkout-internal">
        <fail unless="tag-internal" />
        <exec executable="git" dir="${projects.dir}/ceylon-common" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-compiler" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-spec" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon.language" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-module-resolver" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-runtime" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
        <exec executable="git" dir="${projects.dir}/ceylon-js" failonerror="yes">
            <arg value="checkout"/>
            <arg value="-q"/>
            <arg value="${tag-internal}"/>
        </exec>
    </target>

    <target name="checkout-master">
        <antcall target="checkout-internal">
            <param name="tag-internal" value="master" />
        </antcall>
    </target>

    <target name="checkout-tagged" if="tag">
        <echo message="Checking out tag '${tag}'" />
        <antcall target="checkout-internal">
            <param name="tag-internal" value="${tag}" />
        </antcall>
    </target>

    <target name="clean"
            description="Cleans the distribution package">
        <delete dir="${dist.dir}"/>
    </target>

    <target name="clean-all" depends="clean"
            description="Cleans the distribution package and deletes all local projects">
        <delete dir="${projects.dir}"/>
    </target>
</project>
