<?xml version="1.0" encoding="UTF-8"?>
<project name="ceylon-dist" default="package" basedir=".">

    <property file="build.properties"/>
    <property name="ceylon-compiler.dir" value="${basedir}/../ceylon-compiler"/>
    <property name="ceylon-spec.dir" value="${basedir}/../ceylon-spec"/>
    <property name="ceylon.language.dir" value="${basedir}/../ceylon.language"/>
    <property name="ceylon-module-resolver.dir" value="${basedir}/../ceylon-module-resolver"/>
    <property name="ceylon-runtime.dir" value="${basedir}/../ceylon-runtime"/>
    <property name="dist.name" value="ceylon-${ceylon.version}"/>
    <property name="dist.dir" value="${basedir}/dist"/>

    <target name="package" depends="install-compiler, copy-compiler-binaries, copy-compiler-samples, copy-compiler-libraries, install-typechecker, install-language, install-runtime, generate-spec, generate-apidoc">
        <zip destfile="${basedir}/${dist.name}.zip">
            <zipfileset dir="${dist.dir}" prefix="${dist.name}">
                <include name="bin/**" />
                <exclude name="bin/ceylon*" />
            </zipfileset>
            <zipfileset dir="${dist.dir}" filemode="755"  prefix="${dist.name}">
                <include name="bin/ceylon*" />
            </zipfileset>
            <zipfileset dir="${dist.dir}" prefix="${dist.name}">
                <include name="doc/**" />
                <include name="lib/**" />
                <include name="repo/**" />
                <include name="runtime-repo/**" />
                <include name="samples/**" />
            </zipfileset>
            <zipfileset dir="${basedir}" prefix="${dist.name}">
                <include name="LICENSE" />
                <include name="NOTICE" />
            </zipfileset>
        </zip>        
    </target>

    <target name="copy-compiler-binaries">
        <mkdir dir="${dist.dir}/bin"/>
        <copy todir="${dist.dir}/bin">
            <fileset dir="${ceylon-compiler.dir}/build/bin">
                <include name="args.sh"/>
                <include name="args.bat"/>
                <include name="java.bat"/>
                <include name="ceylonc"/>
                <include name="ceylonc.bat"/>
                <include name="ceylond"/>
                <include name="ceylond.bat"/>
            </fileset>
        </copy>
        <chmod perm="0755">
            <fileset dir="${dist.dir}/bin">
                <include name="ceylonc"/>
                <include name="ceylond"/>
            </fileset>
        </chmod>
    </target>

	<target name="copy-compiler-libraries">
        <mkdir dir="${dist.dir}/lib"/>
        <copy todir="${dist.dir}/lib">
            <fileset dir="${ceylon-compiler.dir}/build/lib">
                <include name="antlr-*-complete.jar"/>
                <include name="markdownj-*.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="copy-compiler-samples">
        <mkdir dir="${dist.dir}/samples"/>
        <copy todir="${dist.dir}/samples">
            <fileset dir="${ceylon-compiler.dir}/samples">
                <include name="helloworld/**"/>
            </fileset>
        </copy>
    </target>

	<target name="install-compiler">
        <ant antfile="${ceylon-compiler.dir}/build.xml" target="dist" dir="${ceylon-compiler.dir}" inheritall="false">
        </ant>
        <copy todir="${dist.dir}/repo">
            <fileset dir="${ceylon-compiler.dir}/build/dist">
            </fileset>
        </copy>
    </target>

    <target name="install-typechecker">
        <ant antfile="${ceylon-spec.dir}/build.xml" target="dist" dir="${ceylon-spec.dir}" inheritall="false">
        </ant>
        <copy todir="${dist.dir}/repo">
            <fileset dir="${ceylon-spec.dir}/build/dist">
            </fileset>
        </copy>
    </target>

    <target name="install-language">
        <ant antfile="${ceylon.language.dir}/build.xml" target="dist" dir="${ceylon.language.dir}" inheritall="false">
        </ant>
        <copy todir="${dist.dir}/repo">
            <fileset dir="${ceylon.language.dir}/build/dist">
            </fileset>
        </copy>
    </target>

    <target name="compile-module-resolver" depends="install-language">
        <exec command="mvn" dir="${ceylon-module-resolver.dir}/">
            <arg value="install"/>
        </exec>
    </target>

    <target name="install-runtime" depends="compile-module-resolver">
        <exec command="mvn" dir="${ceylon-module-resolver.dir}/">
            <arg value="install:install-file"/>
            <arg value="-Dfile=${dist.dir}/repo/ceylon/language/${ceylon.version}/ceylon.language-${ceylon.version}.car"/>
            <arg value="-DgroupId=ceylon.language"/>
            <arg value="-DartifactId=ceylon-language"/>
            <arg value="-Dversion=${ceylon.version}"/>
            <arg value="-Dpackaging=jar"/>
            <arg value="-DgeneratePom=true"/>
            <arg value="-DcreateChecksum=true"/>
        </exec>
        <exec command="mvn" dir="${ceylon-runtime.dir}/">
            <arg value="install"/>
        </exec>
        <copy todir="${dist.dir}">
            <fileset dir="${ceylon-runtime.dir}/dist">
            </fileset>
        </copy>
        <chmod perm="0755">
            <fileset dir="${dist.dir}/bin">
                <include name="ceylon"/>
            </fileset>
        </chmod>
    </target>

    <target name="generate-spec">
        <ant antfile="${ceylon-spec.dir}/build.xml" target="doc" dir="${ceylon-spec.dir}" inheritall="false">
        </ant>
        <copy todir="${dist.dir}/doc">
            <fileset dir="${ceylon-spec.dir}/build">
                <exclude name="dist,classes"/>
            </fileset>
        </copy>
    </target>

    <target name="generate-apidoc">
        <exec command="${dist.dir}/bin/ceylond" >
            <arg value="-out"/>
            <arg value="${dist.dir}/repo"/>
            <arg value="-src"/>
            <arg value="${ceylon.language.dir}/src/"/>
        </exec>
    </target>

    <target name="clean">
        <delete dir="${dist.dir}"/>
    </target>
</project>
