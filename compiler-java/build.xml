<project name="MyProject" default="all" basedir=".">

  <!-- The ANTLR source file for the parser,
       the directory the java files generated
       from it end up in, and the ANTLR jar
       file we'll use to generate one from
       the other -->
  <property name="antlr.src" location="Ceylon.g"/>
  <property name="antlr.dst" location="src/com/redhat/ceylon/compiler/parser"/>
  <property name="antlr.lib" location="lib/antlrworks-1.3.1.jar"/>

  <!-- The Java source files for the compiler -->
  <property name="javac.src" location="langtools/src/share/classes"/>
  <property name="ceylonc.src" location="src"/>

  <!-- The Java and Ceylon source files for the runtime -->
  <property name="runtime.src" location="runtime"/>  
  
  <!-- Directories everything gets built into -->
  <property name="build" location="build"/>
  <property name="build.classes" location="${build}/classes"/>
  <property name="build.lib" location="${build}/lib"/>

  <!-- Jarfiles everything ends up in -->
  <property name="compiler.jar" location="${build.lib}/compiler.jar"/>

  <!-- The directory that parser tests live in, and
       the directory test results get written into -->
  <property name="parser.test.src" location="corpus/tests"/>
  <property name="parser.test.dst" location="${build}/test/parser"/>

  <!-- Rules to build parser classes from the ANTLR grammar -->
  <condition property="antlr.needed">
    <or>
      <not>
        <available file="${antlr.dst}/CeylonParser.java"/>
      </not>
      <not>
        <uptodate
           srcfile="${antlr.src}"
           targetfile="${antlr.dst}/CeylonParser.java"/>
      </not>
    </or>
  </condition>
  <target name="antlr" if="antlr.needed">
    <mkdir dir="${antlr.dst}"/>
    <java classname="org.antlr.Tool">
      <arg value="-o"/>
      <arg value="${antlr.dst}"/>
      <arg value="${antlr.src}"/>
      <classpath>
        <pathelement location="${antlr.lib}"/>
      </classpath>
    </java>
  </target>

  <!-- Rule to build compiler classes from their Java sources -->
  <target name="compiler.classes" depends="antlr">
    <mkdir dir="${build.classes}"/>
    <javac
       srcdir="${javac.src}:${ceylonc.src}"
       destdir="${build.classes}"
       debug="true"
       classpath="${antlr.lib}">
      <include name="com/redhat/**"/>
      <include name="com/sun/tools/javac/**"/>
    </javac>
  </target>

  <!-- Rule to build compiler jar -->
  <target name="compiler.jar" depends="compiler.classes">
    <mkdir dir="${build.lib}"/>
    <jar destfile="${compiler.jar}">
      <fileset dir="${build.classes}">
        <exclude name="ceylon/**"/>
        <exclude name="com/redhat/ceylon/compiler/test/**"/>
      </fileset>
      <fileset dir="${javac.src}">
        <include name="com/sun/tools/javac/resources/*.properties"/>
      </fileset>
    </jar>
  </target>

  <!-- Rule to build runtime classes from their Java and Ceylon sources -->
  <target name="runtime.classes" depends="compiler.jar">
    <apply executable="java">
      <arg value="-ea"/>
      <arg value="-cp"/>
      <arg value="${compiler.jar}:${antlr.lib}:${runtime.src}"/>
      <arg value="com.redhat.ceylon.compiler.Main"/>
      <arg value="-d"/>
      <arg value="${build.classes}"/>
      <arg value="-src"/>
      <arg value="${runtime.src}"/>
      <fileset dir="${runtime.src}/ceylon/language">
	<include name="*.java"/>
	<include name="*.ceylon"/>
      </fileset>
    </apply>
  </target>
  
  <!-- Rule to run the parser regression tests -->
  <target name="test.parser" depends="compiler.jar">
    <mkdir dir="${parser.test.dst}"/>
    <apply executable="java">
      <arg value="-ea"/>
      <arg value="-cp"/>
      <arg value="${compiler.jar}:${antlr.lib}"/>
      <arg value="com.redhat.ceylon.compiler.launcher.CeylonCompiler"/>
      <arg value="-d"/>
      <arg value="${parser.test.dst}"/>
      <fileset dir="${parser.test.src}">
	<include name="*.ceylon"/>
      </fileset>
    </apply>
    <apply executable="diff" failonerror="true">
      <arg value="-w"/>
      <arg value="${parser.test.dst}"/>
      <fileset dir="${parser.test.src}">
	<include name="*.ceylon.out"/>
      </fileset>
    </apply>
  </target>

  <!-- Rule to run the compiler regression tests -->
  <target name="test.compiler" depends="compiler.jar">
    <exec executable="bin/compilertest" failonerror="true"/>
  </target>

  <!-- Rule to just do everything -->
  <target name="all" depends="test.parser,test.compiler"/>

  <!-- Rule to clean everything up -->
  <target name="clean">
    <delete dir="${build}"/>
    <delete dir="${antlr.dst}"/>
  </target>
</project>
